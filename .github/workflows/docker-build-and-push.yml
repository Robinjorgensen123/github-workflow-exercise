name: Docker Build & Push (main)

on:
    push:
        branches: [main]
    workflow_dispatch:


jobs:
    docker:
        runs-on: ubuntu-latest
        permissions:
            contents: read
        steps:
          - name: Checkout
            uses: actions/checkout@v4

          - name: Set up Buildx
            uses: docker/setup-buildx-action@v3

          - name: Log in to Docker hub
            uses: docker/login-action@v3
            with:
             username: ${{ secrets.DOCKERHUB_USERNAME }}
             password: ${{ secrets.DOCKERHUB_TOKEN }}

          - name: Extract metadata (tags, labels)
            id: meta
            uses: docker/metadata-action@v5
            with:
              images: ${{ secrets.DOCKERHUB_USERNAME }}/react-app
              tags: |
                type=raw,value=latest
                type=sha,format=short

          - name: Build and push
            uses: docker/build-push-action@v6
            with:
                context: .
                file: ./Dockerfile
                push: true
                platforms: linux/amd64
                tags: ${{ steps.meta.outputs.tags }}
                labels: ${{ steps.meta.outputs.labels }}
                cache-from: type=gha
                cache-to: type=gha,mode=max
